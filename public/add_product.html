<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Agregar productos</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.0.3/css/font-awesome.css">
    <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/alertifyjs@1.13.1/build/css/alertify.min.css" />
    <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/alertifyjs@1.13.1/build/css/themes/bootstrap.min.css" />
    <script src="https://code.jquery.com/jquery-3.6.1.min.js" integrity="sha256-o88AwQnZB+VDvE9tvIXrMQaPlFFSUTR+nldQm1LuPXQ=" crossorigin="anonymous"></script>
    <script src="//cdn.jsdelivr.net/npm/alertifyjs@1.13.1/build/alertify.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <style type="text/css">
    body {
        color: #000;
        overflow-x: hidden;
        height: 100%;
        background-image: url("https://i.ibb.co/RD9kWTB/images-q-tbn-ANd9-Gc-RX-Wriy-Ij-Jpi-Hy-Hir0-VZNsn-Ap-R9mt-ZFz-G4-Hg6h-Oqq-P6-Xo-Iq-Ixi1o-Ht-Zh-Ni-Cy.jpg");
        background-repeat: no-repeat;
        background-size: 100% 100%
    }

    .card {
        padding: 30px 40px;
        margin-top: 60px;
        margin-bottom: 60px;
        border: none !important;
        box-shadow: 0 6px 12px 0 rgba(0, 0, 0, 0.2)
    }

    .form-control-label {
        margin-bottom: 0
    }

    input,
    textarea,
    button {
        padding: 8px 15px;
        border-radius: 5px !important;
        margin: 5px 0px;
        box-sizing: border-box;
        border: 1px solid #ccc;
        font-size: 18px !important;
        font-weight: 300
    }

    input:focus,
    textarea:focus {
        -moz-box-shadow: none !important;
        -webkit-box-shadow: none !important;
        box-shadow: none !important;
        border: 1px solid #00BCD4;
        outline-width: 0;
        font-weight: 400
    }

    .btn-block {
        text-transform: uppercase;
        font-size: 15px !important;
        font-weight: 400;
        height: 43px;
        cursor: pointer
    }

    .btn-block:hover {
        color: #fff !important
    }

    button:focus {
        -moz-box-shadow: none !important;
        -webkit-box-shadow: none !important;
        box-shadow: none !important;
        outline-width: 0
    }

    .bgstyle {
        border-radius: 10%;
    }

    .title {
        padding-top: 12px;
    }

    .api_used {
        border-radius: 10%;
        padding-top: 6px;
        width: fit-content;
        height: fit-content;
    }
    </style>
</head>

<body>
    <div class="container-fluid px-1 py-5 mx-auto">
        <div class="row d-flex justify-content-center">
            <div class="col-xl-7 col-lg-8 col-md-9 col-11 text-center bg-dark bgstyle">
                <div class="card">
                    <h3 class="text-dark title">Panel de administracion</h3>
                    <div class="form-group col-12 flex-column d-flex align-items-center">
                        <p class="api_used"><b class="text-dark">API: /<a class="text-success" type="text" name="api_used" id="api_used">add</a></p>
                    </div>
                    <h5 class="text-center mb-4" id="subtitle_card">Agregar productos</h5>
                    <form class="form-card" onsubmit="event.preventDefault()" id="productform">
                        <div class="row justify-content-between text-center">
                            <div class="text-center col-12 flex-column d-flex">
                                <img id="imgTest" src="https://i.ibb.co/sJ14zzQ/default-Product-Image.png" width="96px" height="96px" style="align-self: center;"></img>
                            </div>
                        </div>
                        <div class="row justify-content-between text-left">
                            <div class="form-group col-sm-6 flex-column d-flex">
                                <label class="form-control-label px-3">Nombre del producto<span class="text-danger"> *</span></label>
                                <input type="text" id="pname" name="pname" placeholder="Auriculares alta gama..." required>
                            </div>
                            <div class="form-group col-sm-6 flex-column d-flex">
                                <label class="form-control-label px-3">Precio<span class="text-danger"> *</span></label>
                                <input type="number" min="1" id="price" name="price" placeholder="$100" required>
                            </div>
                        </div>
                        <div class="row justify-content-between text-left">
                            <div class="form-group col-sm-6 flex-column d-flex">
                                <label class="form-control-label px-3">Codigo de barras<span class="text-danger"> *</span></label>
                                <input type="text" id="barcode" name="barcode" placeholder="Codigo de barras..." onchange="barcode_s();barcodeChange();" required>
                            </div>
                            <div class="form-group col-sm-6 flex-column d-flex align-items-center align-self-center">
                                <label class="form-control-label px-3">Identificador:</label>
                                <svg id="barcode_s" class="align-self: center;"></svg>
                            </div>
                            <div class="form-group col-sm-6 flex-column d-flex">
                                <label class="form-control-label px-3">Cantidad<span class="text-danger"> *</span></label>
                                <input type="number" min="1" id="stock" name="stock" placeholder="50 (En stock)" required>
                            </div>
                        </div>
                        <div class="row justify-content-between text-left">
                            <div class="form-group col-sm-6 flex-column d-flex">
                                <label class="form-control-label px-3">Tipo<span class="text-danger"> *</span></label>
                                <select type="text" id="type" name="type" class="form-select" required>
                                    <option selected disabled>Selecciona la categoria</option>
                                    <option value="auriculares">Auriculares</option>
                                    <option value="adaptadores">Adaptadores</option>
                                    <option value="bocinas">Bocinas</option>
                                    <option value="cargador">Cargadores</option>
                                    <option value="cables">Cables</option>
                                    <option value="decorativos">Decorativos</option>
                                    <option value="fundas">Fundas</option>
                                    <option value="relojes">Relojes</option>
                                    <option value="luces">Luces</option>
                                </select>
                            </div>
                        </div>
                        <div class="row justify-content-between text-left">
                            <div class="form-group col-12 flex-column d-flex">
                                <button id="comeback" type="button" class="btn-block btn-primary" onclick="location.reload();">Volver al modo de agregar</button>
                                <label class="form-control-label px-3" id="textimage">Imagen<span class="text-danger"> *</span></label>
                                <input type="file" id="image" name="image" placeholder="" accept="image/*" onchange="encodeImageFileAsURL()" required="true" />
                            </div>
                        </div>
                        <div class="row justify-content-end">
                            <div class="form-group col-sm-6">
                                <button type="submit" class="btn-block btn-primary">Enviar</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <div id="postData"></div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4" crossorigin="anonymous"></script>
    <script type='text/javascript'>
    function encodeImageFileAsURL() {
        var filesSelected = document.getElementById("image").files;
        if (filesSelected.length > 0) {
            var fileToLoad = filesSelected[0];
            var fileReader = new FileReader();
            fileReader.onload = function(fileLoadedEvent) {
                var srcData = fileLoadedEvent.target.result;
                var newImage = document.getElementById('imgTest')
                newImage.src = srcData;
            }
            fileReader.readAsDataURL(fileToLoad);
        }
    }

    function syncro(data) {
        console.log(data.type)
        $("#pname").val(data.name)
        $("#price").val(data.price)
        $("#stock").val(data.stock)
        $("#type").val(data.type)
        $("#barcode").val(data.barcode)
        console.log(data.barcode)
        JsBarcode("#barcode_s", data.barcode, { format: "CODE128" });
        document.getElementById("imgTest").src = '/img/' + data.path_image;
        document.getElementById("subtitle_card").textContent = 'Actualizando datos';
        document.getElementById("api_used").textContent = 'update';
        $("#comeback").show();
        if (document.getElementById("image") != null) document.getElementById("image").remove();
        if (document.getElementById("textimage") != null) document.getElementById("textimage").remove();
    }

    function barcode_s() {
        let text_code = $("#barcode").val();
        var data_sync
        $.ajax({
            type: "GET",
            url: "/api/" + text_code,
            contentType: "application/json; charset=utf-8",
            crossDomain: true,
            dataType: "json",
            success: function(data, status, jqXHR) {
                data_sync = data[0];
                alertify.confirm('Se ha encontrado un registro para: ' + text_code,
                    '¿Deseas sincronizar los datos?',
                    function() {
                        syncro(data_sync);
                        alertify.success('Ok')
                    },
                    function() {
                        alertify.error('Cancel')
                    });
            },

            error: function(jqXHR, status) {
                if (status == "error") return 0;
            }
        });

    }

    function barcodeChange() {
        let text_code = $("#barcode").val();
        JsBarcode("#barcode_s", text_code, { format: "CODE128" });
    }
    $(document).ready(function() {
        $("#comeback").hide();
        JsBarcode("#barcode_s", "00000000000", { format: "CODE128" });
        $('#productform').submit(function(e) {
            e.preventDefault();
            if (document.getElementById("api_used").textContent == "add") {
                q = document.getElementById("imgTest").src;
                var formData = {
                    name: $("#pname").val(),
                    price: $("#price").val(),
                    stock: $("#stock").val(),
                    type: $("#type").val(),
                    barcode: $("#barcode").val(),
                    image: q,
                };
                console.log(formData)
                $.ajax({
                    url: "/v1/add",
                    type: "POST",
                    data: formData,
                    success: function(data, status, jqXHR) {
                        //$("#postData").html(data);
                        alertify.notify('Producto agregado.', 'success', 5, function() { console.log('dismissed'); });
                    },
                    error: function(jqXHR, status) {
                        alertify.notify('Ha ocurrido un error al enviar.', 'error', 5, function() { console.log('dismissed'); });
                    }
                });
            } else {
                var formData = {
                    name: $("#pname").val(),
                    price: $("#price").val(),
                    stock: $("#stock").val(),
                    type: $("#type").val(),
                    barcode: $("#barcode").val(),
                };
                console.log(formData)
                $.ajax({
                    url: "/v1/update",
                    type: "POST",
                    data: formData,
                    success: function(data, status, jqXHR) {
                        //$("#postData").html(data);
                        alertify.notify('Producto actualizado.', 'success', 5, function() { console.log('dismissed'); });
                    },
                    error: function(jqXHR, status) {
                        var notification = alertify.notify('Ha ocurrido un error al enviar.', 'error', 5, function() { console.log('dismissed'); });
                    }
                });
            }
        });
    });
    </script>
</body>

</html>